# 1. 初步认识自动配置
----

**导入场景，容器中就会自动配置好这个场景的核心组件！容器中有了什么组件，就有了什么功能！**

>导入SpringWeb场景，就会自动配置好tomcat、SpringMVC等

- 以前：需要手动配置一些需要用的组件，如 DispatcherServlet、ViewResolver、CharacterEncodingFilter....
- 现在：导入场景自动配置好了
- 验证：
```java
public static void main(String[] args) {
        //java10： 局部变量类型的自动推断
        var ioc = SpringApplication.run(MainApplication.class, args);
        //1、获取容器中所有组件的名字
        String[] names = ioc.getBeanDefinitionNames();
        //2、挨个遍历：
        // dispatcherServlet、characterEncodingFilter、multipartResolver
        // SpringBoot把以前配置的核心组件现在都给我们自动配置好了。
        for (String name : names) {
            System.out.println(name);
        }
    }
```

# 2. 默认的包扫描规则
----
component-scan功能：默认扫描主程序类（`@SpringBootApplication`标注的类）所在包及其子包的组件
```java
@SpringBootApplication  //这是一个SpringBoot应用  
public class MainApplication {  
    public static void main(String[] args) {  
        SpringApplication.run(MainApplication.class, args);  
    }  
}
```
![[CleanShot 2023-08-02 at 10.07.37.png|300]]
### 更改包扫描路径的两种方法
1. 指定scanBasePackages字段
```java
@SpringBootApplication(scanBasePackages = "com.meitou")  //这是一个SpringBoot应用  
public class MainApplication {  
    public static void main(String[] args) {  
        SpringApplication.run(MainApplication.class, args);  
    }  
}
```
2. 更改ComponentScan标注
点进`@SpringBootApplication`标注，可以看到由6个子注释组成：
- @Target
- @Retention
- @Documented  
- @Inherited  
- @SpringBootConfiguration  
- @EnableAutoConfiguration  
- @ComponentScan
```java
@SpringBootConfiguration  
@EnableAutoConfiguration  
@ComponentScan("com.meitou")
public class MainApplication {  
    public static void main(String[] args) {  
        SpringApplication.run(MainApplication.class, args);  
    }  
}
```

# 3. 配置默认值
----
### 配置文件与属性类
配置文件的**所有配置项**是和**属性类的对象值**进行一一绑定的！
>SpringBoot属性类：封装了各个组件配置的字段，与配置文件中的每一项值绑定！
>
>比如：`ServerProperties`绑定了所有Tomcat服务器有关的配置，`MultipartProperties`绑定了所有文件上传相关的配置...

在配置文件`application.properties`中写入：
```java
server.port=8090
```

按住`cmd`点进字段，可以找到对应的配置类及其字段：
```java
public class ServerProperties {  
    private Integer port;
    
    public void setPort(Integer port) {  
        this.port = port;  
	}
}
```

### 如何获取/更改配置项的默认值
- 参照[官方文档](https://docs.spring.io/spring-boot/docs/current/reference/html/application-properties.html#appendix.application-properties.server)
- 参照绑定的属性类

# 4. 按需加载默认配置
----
在pom中导入web场景启动器:
```xml
    <dependency>  
        <groupId>org.springframework.boot</groupId>  
        <artifactId>spring-boot-starter-web</artifactId>  
    </dependency>
```
点进去可以看到，会导入改场景下的**相关功能依赖组件**以及`spring-boot-starter`:
```xml
<dependencies>
    
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter</artifactId>
      <version>3.0.5</version>
      <scope>compile</scope>
    </dependency>
    
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-json</artifactId>
      <version>3.0.5</version>
      <scope>compile</scope>
    </dependency>
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-tomcat</artifactId>
      <version>3.0.5</version>
      <scope>compile</scope>
    </dependency>
    <dependency>
      <groupId>org.springframework</groupId>
      <artifactId>spring-web</artifactId>
      <version>6.0.7</version>
      <scope>compile</scope>
    </dependency>
    <dependency>
      <groupId>org.springframework</groupId>
      <artifactId>spring-webmvc</artifactId>
      <version>6.0.7</version>
      <scope>compile</scope>
    </dependency>
  </dependencies>
  ```

### 核心场景启动器`spring-boot-starter`

>是所有starter的starter，基础核心starter

点进去，看到它的依赖：
```xml
 <dependencies>
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot</artifactId>
      <version>3.0.5</version>
      <scope>compile</scope>
    </dependency>
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-autoconfigure</artifactId>
      <version>3.0.5</version>
      <scope>compile</scope>
    </dependency>
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-logging</artifactId>
      <version>3.0.5</version>
      <scope>compile</scope>
    </dependency>
    <dependency>
      <groupId>jakarta.annotation</groupId>
      <artifactId>jakarta.annotation-api</artifactId>
      <version>2.1.1</version>
      <scope>compile</scope>
    </dependency>
    <dependency>
      <groupId>org.springframework</groupId>
      <artifactId>spring-core</artifactId>
      <version>6.0.7</version>
      <scope>compile</scope>
    </dependency>
    <dependency>
      <groupId>org.yaml</groupId>
      <artifactId>snakeyaml</artifactId>
      <version>1.33</version>
      <scope>compile</scope>
    </dependency>
  </dependencies>
  ```

可以发现，其导入了一个包 `spring-boot-autoconfigure`。包里面都是各种场景的`AutoConfiguration`——**自动配置类**
![[CleanShot 2023-08-02 at 10.37.34.png|400]]

tips: 虽然全场景的自动配置都在 `spring-boot-autoconfigure`这个包，但是不是全都开启的。导入哪个场景就开启哪个自动配置!

# 5. 详解自动配置流程
---
## 细节梳理
### 1. 导入场景启动器

如web开发场景启动器`stater-web`
1. 导入相关场景的功能依赖：`starter-json`,`starter-tomcat`,`springmvc`等
2. 导入核心启动器`spring-boot-starter`（每个场景都包含），其中引入了`spring-boot-autoconfigure`包

>**spring-boot-autoconfigure**: 里面囊括了所有场景的所有配置内容，是一堆**官方写好的配置类**
>- 只要这个包下的配置类生效，则相当于SpringBoot官方写好的整合功能就生效！
>- 而SpringBoot默认扫描不到这个包下的配置类，默认只扫描主程序类所在包及其子包！

### 2. 主程序启动：@SpringBootApplication
@SpringBootApplication注解由三个注解组成：
- @SpringBootConfiguration
- @ComponentScan
- `@EnableAutoConfiguration`：是SpringBoot开启自动配置的核心！以下详细解说自动配置的步骤：

1. 由子注解 `@Import({AutoConfigurationImportSelector.class})`提供功能：批量给容器中导入组件
2. SpringBoot会默认加载142个配置类，这142个配置类来自于spring-boot-autoconfigure下 `META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports`文件中写好的全类名，这些类名都是xxxAutoConfiguration ———— 已经写好的自动配置类：可以向容器中加入配置好的组件。
3. 按需生效：虽然导入了，但这142个自动配置类并不会都生效！这些自动配置类均有条件注解，只有条件成立才会生效！！！

>项目启动时，利用 @import 批量导入组件机制，将autoconfigure包下的142个**自动配置类** (xxxAutoConfiguration)导入进来，并按需生效。


### 3. 自动配置类 `xxxAutoConfiguration`

1. 使用@Bean向容器中添加一堆组件
2. 含有`@EnableConfigurationProperties(xxxProperties.class)`注解，用来把配置文件中配的指定前缀的属性值封装到 `xxxProperties`**属性类**中
3. 容器中所有组件的一些核心参数，都来自于对应的xxxProperties属性类，而其都是和配置文件绑定

>只需改配置文件的值，就可以改变核心组件的底层参数！

## 核心流程总结
1. 导入`starter`，就导入了`autoconfiguration`包
2. autoconfigure 包里有一个文件，指定了所有启动时会被加载的自动配置类：META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports
3. 主程序类中，@EnableAutoConfiguration，会自动把上面文件写入的自动配置类(`xxxAutoConfiguration`)都导入进来，这些自动配置类有条件注解，会进行按需加载！
4. 自动配置类(xxxAutoConfiguration)，给容器导入了一堆组件，组件都是从 `xxxProperties`属性类中提取属性值
5. xxxProperties属性类和配置文件是绑定的
![[Pasted image 20230802104317.png]]
![[尚硅谷SpringBoot3零基础教程，springboot入门到实战 - 011 - 11.自动配置-深入理解自动配置原理.mp4]]