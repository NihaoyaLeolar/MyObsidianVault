---
tags:
  - Redis实践项目-黑马点评
  - HEAD
---
- [[项目准备]]
# 系统架构
---
系统虽然是单体的，但做了水平拓展：部署多个tomcat，形成负载均衡集群。
![[CleanShot 2024-02-26 at 16.06.44@2x.png]]
# 具体实践记录
---
这里浅浅记录一下我的理解和思考，具体的可以看讲义和视频！
## 1. 短信登录
- 先热热身，了解一下登录逻辑，[[基于Session的短信登录]]
- Session实现登录在单一服务器开发中十分常用，但是本项目的服务器是分布式的，所以存在[[集群session共享问题]]，且存在[[跨站请求伪造-CSRF攻击]]。所以这里使用 Redis 来代替 Session 实现登录业务：[[基于Redis实现短信登录]]
## 2. 商户缓存
- [[实现商户信息缓存]]

然后实践一些缓存问题：
- 解决**数据一致性**问题：根据[[缓存更新策略的最佳实践方案]]，为[[商户添加缓存更新策略]]
- 解决**缓存穿透**问题：根据[[缓存穿透问题与解决思路]]，为[[商户查询解决缓存穿透]]
- 探讨[[缓存雪崩]]问题，给出理论上的解决方案，没有实践解决
- 解决**缓存击穿**问题：根据[[缓存击穿问题与解决原理]]
	- [[基于互斥锁解决商户查询可能的缓存击穿问题]]
	- [[基于逻辑过期方式解决商户查询可能的缓存击穿问题]]
	- 并对上面两种解决方式的编码，[[测试缓存击穿得到了解决]]

封装工具类：[[封装Redis工具类]]

## 3. 利用Redis做自增Id
由于[[简单的自增Id设计]]的局限性，这里我们做[[全局ID生成器]]，利用redis的自增来[[实现全局唯一Id]]
## 4. 优惠券秒杀
- 了解[[优惠券的数据结构]]
- 简单实现[[实现秒杀的基本下单功能]]，用户登录后即可点击购买，可以测试成功，但这里还没涉及到秒杀会出现的任务。
#### 4.1 超卖问题
当我使用[[JMeter 工具]]来并发地发送购买请求，1秒发送200次购买请求，但是优惠券库存只有100个。这时候会出现[[超卖问题]]：运行完后，数据库中库存变成了-9，订单产生了109个。
超卖问题是典型的多线程安全问题，针对这一问题常见的解决方案就是**加锁**。这里要先知道[[悲观锁与乐观锁]]，并且这里采[[用乐观锁解决超卖问题]]。（这里有很重要的一个点：**乐观锁是在数据更新时来用的**）

#### 4.2 一人一单问题
需求：修改秒杀业务，要求同一个优惠券，一个用户只能下一单。
[[实现一人一单需求]]，这个需求很明显也会造成多线程安全问题，所以需要继续加锁来解决。上面乐观锁在这不好用，因为这里操作数据库不是更新操作，而是插入操作！所以这里采[[用悲观锁来解决一人多单问题]]

这里[[使用Idea运行集群效果]]，进行测试，发现依旧存在一人多单的问题。因为存在[[分布式集群下悲观锁失效]]：我们上面采用的synchronize悲观锁，无法解决分布式集群的并发安全问题！